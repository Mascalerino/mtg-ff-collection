<div class="app-container">
  <header class="header">
    <div class="header-top">
      <h1>MTG FINAL FANTASY</h1>

      <div class="header-controls">
        <!-- Selector de set -->
        <div class="set-selector">
          <label>
            <span>{{ t('setLabel') }}</span>
            <select [(ngModel)]="setType" (ngModelChange)="onSetTypeChange($event)">
              <option value="complete">{{ t('setComplete') }}</option>
              <option value="unique">{{ t('setUnique') }}</option>
            </select>
          </label>
        </div>

        <!-- Selector de idioma -->
        <div class="lang-switcher">
          <label>
            <span>{{ t('languageLabel') }}</span>
            <select [(ngModel)]="language" (ngModelChange)="changeLanguage($event)">
              <option value="es">Español</option>
              <option value="en">English</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="summary" *ngIf="!loading && !errorKey">
      <p>{{ t('totalCards') }}: <strong>{{ totalCards }}</strong></p>
      <p>{{ t('cardsOwned') }}: <strong>{{ ownedCards }}</strong></p>
      <p>{{ t('uniqueCards') }}: <strong>{{ uniqueOwnedCards }}</strong></p>
      <p>{{ t('repeatedCards') }}: <strong>{{ repeatedCards }}</strong></p>
      <p>
        {{ t('progress') }}:
        <strong>{{ completionPercentage | number: '1.0-1' }}%</strong>
      </p>
      <p>
        {{ t('estimatedValue') }}:
        <strong>{{ collectionValueEur | number: '1.2-2' }} €</strong>
        <span class="summary-note">
          {{ t('summaryNote') }}
        </span>
      </p>
    </div>

    <!-- Estadísticas por rareza -->
    <div class="summary rarity-summary" *ngIf="!loading && !errorKey">
      <p class="rarity-title"><strong>{{ t('rarityStats') }}</strong></p>
      
      <div class="rarity-stats-grid">
        <!-- Common -->
        <div class="rarity-stat">
          <p class="rarity-name">{{ t('common') }}:</p>
          <p>{{ t('cardsOwned') }}: <strong>{{ getRarityOwnedCards('common') }}/{{ getRarityTotalCards('common') }}</strong></p>
          <p>{{ t('repeatedCards') }}: <strong>{{ getRarityRepeatedCards('common') }}</strong></p>
          <p>{{ t('estimatedValue') }}: <strong>{{ getRarityValue('common') | number: '1.2-2' }} €</strong></p>
        </div>
        
        <!-- Uncommon -->
        <div class="rarity-stat">
          <p class="rarity-name">{{ t('uncommon') }}:</p>
          <p>{{ t('cardsOwned') }}: <strong>{{ getRarityOwnedCards('uncommon') }}/{{ getRarityTotalCards('uncommon') }}</strong></p>
          <p>{{ t('repeatedCards') }}: <strong>{{ getRarityRepeatedCards('uncommon') }}</strong></p>
          <p>{{ t('estimatedValue') }}: <strong>{{ getRarityValue('uncommon') | number: '1.2-2' }} €</strong></p>
        </div>
        
        <!-- Rare -->
        <div class="rarity-stat">
          <p class="rarity-name">{{ t('rare') }}:</p>
          <p>{{ t('cardsOwned') }}: <strong>{{ getRarityOwnedCards('rare') }}/{{ getRarityTotalCards('rare') }}</strong></p>
          <p>{{ t('repeatedCards') }}: <strong>{{ getRarityRepeatedCards('rare') }}</strong></p>
          <p>{{ t('estimatedValue') }}: <strong>{{ getRarityValue('rare') | number: '1.2-2' }} €</strong></p>
        </div>
        
        <!-- Mythic -->
        <div class="rarity-stat">
          <p class="rarity-name">{{ t('mythic') }}:</p>
          <p>{{ t('cardsOwned') }}: <strong>{{ getRarityOwnedCards('mythic') }}/{{ getRarityTotalCards('mythic') }}</strong></p>
          <p>{{ t('repeatedCards') }}: <strong>{{ getRarityRepeatedCards('mythic') }}</strong></p>
          <p>{{ t('estimatedValue') }}: <strong>{{ getRarityValue('mythic') | number: '1.2-2' }} €</strong></p>
        </div>
      </div>
    </div>

    <div *ngIf="loading" class="status">{{ t('loadingCards') }}</div>
    <div *ngIf="errorKey" class="status error">{{ t(errorKey) }}</div>
  </header>

  <main class="main-content" *ngIf="!loading && !errorKey">
    <!-- Barra de acciones: exportar / importar + filtros -->
    <section class="toolbar">
      <div class="toolbar-left">
        <button type="button" (click)="exportCollection()">
          {{ t('export') }}
        </button>

        <label class="import-label">
          {{ t('import') }}
          <input
            type="file"
            accept="application/json"
            (change)="onImportFileSelected($event)"
          />
        </label>

        <span class="import-error" *ngIf="importErrorKey">
          {{ t(importErrorKey) }}
        </span>
      </div>

      <div class="toolbar-right">
        <div class="filter-item">
          <label>
            {{ t('search') }}:
            <input
              type="text"
              [placeholder]="t('searchPlaceholder')"
              [(ngModel)]="searchTerm"
            />
          </label>
        </div>

        <div class="filter-item">
          <label>
            {{ t('rarity') }}:
            <select [(ngModel)]="filterRarity">
              <option value="all">{{ t('all') }}</option>
              <option value="common">Common</option>
              <option value="uncommon">Uncommon</option>
              <option value="rare">Rare</option>
              <option value="mythic">Mythic</option>
            </select>
          </label>
        </div>

        <div class="filter-item">
          <label>
            {{ t('ownership') }}:
            <select [(ngModel)]="filterOwnership">
              <option value="all">{{ t('all') }}</option>
              <option value="owned">{{ t('owned') }}</option>
              <option value="missing">{{ t('missing') }}</option>
              <option value="foilOwned">{{ t('foilOwned') }}</option>
              <option value="wanted">{{ t('wanted') }}</option>
            </select>
          </label>
        </div>

        <div class="filter-item">
          <label>
            {{ t('sortBy') }}:
            <select [(ngModel)]="sortBy">
              <option value="collectorNumber">{{ t('sortCollectorNumber') }}</option>
              <option value="collectorNumberDesc">{{ t('sortCollectorNumberDesc') }}</option>
              <option value="nameAsc">{{ t('sortNameAsc') }}</option>
              <option value="nameDesc">{{ t('sortNameDesc') }}</option>
              <option value="priceAsc">{{ t('sortPriceAsc') }}</option>
              <option value="priceDesc">{{ t('sortPriceDesc') }}</option>
            </select>
          </label>
        </div>
      </div>
    </section>

    <!-- Grid de cartas -->
    <section class="cards-grid">
      <div class="card-item" *ngFor="let card of filteredCards">
        <div class="card-image-wrapper" *ngIf="card.imageUrl; else noImage">
          <a
            [href]="getCardmarketUrl(card)"
            target="_blank"
            rel="noopener noreferrer"
            [title]="t('viewOnCardmarketTitle')"
          >
            <img [src]="card.imageUrl" [alt]="card.name" loading="lazy" />
          </a>
        </div>
        <ng-template #noImage>
          <div class="no-image">{{ t('noImage') }}</div>
        </ng-template>

        <div class="card-info">
          <!-- ⭐ Estrella + nombre -->
          <div class="card-title-line">
            <span
              class="star"
              [class.active]="isWanted(card.id)"
              (click)="toggleWanted(card.id)"
            >
              {{ isWanted(card.id) ? '★' : '☆' }}
            </span>

            <h3>
              <a
                [href]="getCardmarketUrl(card)"
                target="_blank"
                rel="noopener noreferrer"
                [title]="t('viewOnCardmarketTitle')"
              >
                {{ card.name }}
              </a>
            </h3>
          </div>

          <p>#{{ card.collectorNumber }} · {{ card.rarity | titlecase }}</p>

          <p
            class="price"
            *ngIf="card.eurPriceNonFoil !== null || card.eurPriceFoil !== null"
          >
            <ng-container *ngIf="card.eurPriceNonFoil !== null">
              {{ t('priceNormal') }}:
              {{ card.eurPriceNonFoil | number: '1.2-2' }} €
            </ng-container>
            <ng-container *ngIf="card.eurPriceFoil !== null">
              <span *ngIf="card.eurPriceNonFoil !== null">&nbsp;·&nbsp;</span>
              {{ t('priceFoil') }}:
              {{ card.eurPriceFoil | number: '1.2-2' }} €
            </ng-container>
          </p>

          <div class="ownership">
            <div class="field" *ngIf="card.hasNonFoil">
              <label>
                {{ t('normalCopies') }}:
                <input
                  type="number"
                  min="0"
                  [ngModel]="getNormalQty(card.id)"
                  (ngModelChange)="onNormalQtyChange(card.id, $event)"
                />
              </label>
            </div>
            <div class="field" *ngIf="!card.hasNonFoil">
              <span class="note">
                {{ t('noNonfoil') }}
              </span>
            </div>

            <div class="field" *ngIf="card.hasFoil">
              <label>
                {{ t('foilCopies') }}:
                <input
                  type="number"
                  min="0"
                  [ngModel]="getFoilQty(card.id)"
                  (ngModelChange)="onFoilQtyChange(card.id, $event)"
                />
              </label>
            </div>
            <div class="field" *ngIf="!card.hasFoil">
              <span class="note">
                {{ t('noFoil') }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>